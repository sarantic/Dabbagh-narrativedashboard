<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Median & Average Wages (1973–2022)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="javascript/tooltip.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #e3f2fd, #cfd8dc);
      text-align: center;
      color: #333;
    }

    h1 {
      color: #2a6786;
    }

    #vis {
      margin: 30px auto;
      width: 80%;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    }

    button {
      background-color: #dbb286;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
    }

    button:hover {
      background-color: #f7f5e8;
    }
    .tooltip {
  font-size: 13px;
  color: #333;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
    
    .scene1-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.scene1-text {
  max-width: 600px;
  margin-bottom: 20px;
  text-align: left;
  
}
    .annotation-note-title {
  font-weight: bold;
  font-size: 14px;
  fill: #2a6786;
}

.annotation-note-label {
  fill: #555;
  font-size: 12px;
}
    .annotation-note-bg {
  fill: white;
  stroke: none;
  rx: 4;
  ry: 4;
  filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.1));
}





  </style>
</head>
<body>
  <h1>Median & Average Hourly Wages in the U.S. (1973–2022)</h1>

  <div id="vis"></div>

  <div>
    <button onclick="prevScene()">Previous</button>
    <button onclick="nextScene()">Next</button>
  </div>

  <script>
    var sceneIndex = 0;
    var scenes = [scene1, scene2, scene3, scene4];
    var wageData = [];


   async function init() {
      try {
        const data = await d3.csv("data/median_average_wages.csv");
    
        data.forEach(function(d) {
            d.year = +d.year;
            d.average = +d.average;
            d.women_average = +d.women_average;
            d.men_average = +d.men_average;
          });

    
        window.wageData = data;
        scenes[sceneIndex]();
      } catch (error) {
        console.log("Error loading or parsing CSV:", error);
      }
    }


    function nextScene() {
      sceneIndex = (sceneIndex + 1) % scenes.length;
      scenes[sceneIndex]();
    }

    function prevScene() {
      sceneIndex = (sceneIndex - 1 + scenes.length) % scenes.length;
      scenes[sceneIndex]();
    }


function renderChart(trigger) {
  d3.select("#vis").html("");

  const svgWidth = 800;
  const svgHeight = 500;
  var margin = { top: 90, right: 100, bottom: 80, left: 80 };
var width = 800 - margin.left - margin.right;
var height = 500 - margin.top - margin.bottom;
   const showTrendLines = trigger.showTrendLines ?? false;



  const svg = d3.select("#vis")
    .append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight)
    .style("font-family", "Inter, sans-serif");

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const data = window.wageData;
  data.sort((a, b) => a.year - b.year);

  const x = d3.scaleLinear()
    .domain(d3.extent(data, d => d.year))
    .range([0, width]);

  const y = d3.scaleLinear()
    .domain([0, d3.max(data, d => Math.max(d.men_average, d.women_average))])
    .range([height, 0]);

  const menLine = d3.line()
    .x(d => x(d.year))
    .y(d => y(d.men_average));

  const womenLine = d3.line()
    .x(d => x(d.year))
    .y(d => y(d.women_average));

  const menPath = g.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("stroke-width", 4)
    .attr("d", menLine);

  const womenPath = g.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "orange")
    .attr("stroke-width", 4)
    .attr("d", womenLine);
  // Draw trend lines (dotted red)
if (showTrendLines) {
  const menTrend = getTrendLine(data, d => d.year, d => d.men_average);
  const womenTrend = getTrendLine(data, d => d.year, d => d.women_average);

  const trendLine = d3.line()
    .x(d => x(d.x))
    .y(d => y(d.y));

  [menTrend, womenTrend].forEach((trend, index) => {
    const path = g.append("path")
      .datum(trend)
      .attr("d", trendLine)
      .attr("stroke", "red")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", "5 5")
      .attr("fill", "none");

    // Animation
    const length = path.node().getTotalLength();
    path.attr("stroke-dasharray", length + " " + length)
        .attr("stroke-dashoffset", length)
        .transition()
        .duration(1500)
        .delay(1000)  // 1s delay
        .attr("stroke-dashoffset", 0);
  });
}




  if (trigger.animate) {
    [menPath, womenPath].forEach(path => {
      const length = path.node().getTotalLength();
      path.attr("stroke-dasharray", length + " " + length)
          .attr("stroke-dashoffset", length)
          .transition()
          .duration(2000)
          .attr("stroke-dashoffset", 0);
    });
  }

  // Axes
 g.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x).tickFormat(d3.format("d")))
  .selectAll("text")
  .style("text-anchor", "middle")
  .attr("dx", "0em")
  .attr("dy", "1.5em")


  g.append("g")
    .call(d3.axisLeft(y));

  // Titles
  if (trigger.title) {
    svg.append("text")
      .attr("x", svgWidth / 2)
      .attr("y", 20)
      .attr("text-anchor", "middle")
      .text(trigger.title)
      .style("font-size", "16px");
  }

  if (trigger.annotationText) {
    svg.append("text")
      .attr("x", svgWidth / 2)
      .attr("y", 40)
      .attr("text-anchor", "middle")
      .text(trigger.annotationText)
      .style("font-size", "12px")
      .style("fill", "gray");
  }

  // Tooltip overlay + logic
  const focusLine = g.append("line")
    .attr("stroke", "#aaa")
    .attr("stroke-width", 1)
    .attr("y1", 0)
    .attr("y2", height)
    .style("opacity", 0);

  const focusCircleMen = g.append("circle")
    .attr("r", 4)
    .attr("fill", "steelblue")
    .style("opacity", 0);

  const focusCircleWomen = g.append("circle")
    .attr("r", 4)
    .attr("fill", "orange")
    .style("opacity", 0);

  const tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("background", "#fff")
    .style("padding", "8px")
    .style("border", "1px solid #ccc")
    .style("border-radius", "4px")
    .style("opacity", 0)
    .style("pointer-events", "none");

  const bisect = d3.bisector(d => d.year).left;

  function onMouseMove(event) {
    const mouseX = d3.pointer(event)[0];
    const yearEstimate = x.invert(mouseX);
    const i = bisect(data, yearEstimate);
    const d = data[i] || data[data.length - 1];

    focusLine.attr("x1", x(d.year)).attr("x2", x(d.year)).style("opacity", 1);
    focusCircleMen.attr("cx", x(d.year)).attr("cy", y(d.men_average)).style("opacity", 1);
    focusCircleWomen.attr("cx", x(d.year)).attr("cy", y(d.women_average)).style("opacity", 1);

    tooltip.html(`
      <strong>Year:</strong> ${d.year}<br/>
      <strong>Men:</strong> $${d.men_average.toFixed(2)}<br/>
      <strong>Women:</strong> $${d.women_average.toFixed(2)}
    `)
    .style("left", (event.pageX + 10) + "px")
    .style("top", (event.pageY - 28) + "px")
    .style("opacity", 1);
  }

  function onMouseOut() {
    tooltip.style("opacity", 0);
    focusLine.style("opacity", 0);
    focusCircleMen.style("opacity", 0);
    focusCircleWomen.style("opacity", 0);
  }

  g.append("rect")
    .attr("class", "hover-overlay")
    .attr("width", width)
    .attr("height", height)
    .attr("fill", "none")
    .attr("pointer-events", "all")
    .on("mousemove", onMouseMove)
    .on("mouseout", onMouseOut);

  // Optional: Highlight specific years
  if (trigger.highlightYears) {
    trigger.highlightYears.forEach(year => {
      const point = data.find(d => d.year === year);
      if (point) {
        g.append("circle")
          .attr("cx", x(point.year))
          .attr("cy", y(point.men_average))
          .attr("r", 6)
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 2);

        g.append("circle")
          .attr("cx", x(point.year))
          .attr("cy", y(point.women_average))
          .attr("r", 6)
          .attr("fill", "none")
          .attr("stroke", "orange")
          .attr("stroke-width", 2);
      }
    });
  }

  // Optional: Annotation line between men/women
  if (trigger.annotationYear !== null) {
    const focus = data.find(d => d.year === trigger.annotationYear);
    if (focus) {
      g.append("text")
        .attr("x", x(focus.year) + 10)
        .attr("y", y(focus.men_average) - 20)
        .style("fill", "steelblue")
        .text("Men $" + focus.men_average.toFixed(2));

      g.append("text")
        .attr("x", x(focus.year) + 10)
        .attr("y", y(focus.women_average) + 20)
        .style("fill", "orange")
        .text("Women $" + focus.women_average.toFixed(2));

      g.append("line")
        .attr("x1", x(focus.year))
        .attr("y1", y(focus.men_average))
        .attr("x2", x(focus.year))
        .attr("y2", y(focus.women_average))
        .attr("stroke", "gray")
        .attr("stroke-dasharray", "4 2");
    }
  }
}


    

function scene1() {
  d3.select("#vis").html(""); // Clear previous content

  //container div
  const container = d3.select("#vis")
    .append("div")
    .attr("class", "scene1-container");

  //  intro text
  container.append("div")
    .attr("class", "scene1-text")
    .html(`
      <h2>The Starting Point: 1973</h2>
      <p>In 1973, the U.S. labor market was still strongly divided by gender. 
         Women had entered the workforce in growing numbers, but systemic inequities persisted.
         The average hourly wage for men was <strong>$26.96</strong>, while for women it was just <strong>$17.31</strong>.</p>
      <p>This represented a wage gap of <strong>$9.65</strong>, or <strong>36%</strong> less for women on average.</p>
    `);

  // Bar chart dimensions
  const svgWidth = 500;
  const svgHeight = 300;
  const margin = { top: 30, right: 20, bottom: 50, left: 80 };
  const width = svgWidth - margin.left - margin.right;
  const height = svgHeight - margin.top - margin.bottom;

  // Sample 1973 data
  const barData = [
    { group: "Men", value: 26.96 },
    { group: "Women", value: 17.31 }
  ];

  const svg = container.append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

  const x = d3.scaleBand()
    .domain(barData.map(d => d.group))
    .range([0, width])
    .padding(0.4);

  const y = d3.scaleLinear()
    .domain([0, d3.max(barData, d => d.value) * 1.2])
    .range([height, 0]);

  // Axes
  g.append("g")
    .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(x));

  g.append("g")
    .call(d3.axisLeft(y).ticks(5));

  // Bars
 g.selectAll(".bar")
  .data(barData)
  .enter()
  .append("rect")
  .attr("class", "bar")
  .attr("x", d => x(d.group))
  .attr("y", height) // Start at bottom
  .attr("width", x.bandwidth())
  .attr("height", 0) // Height is 0 at start
  .attr("fill", d => d.group === "Men" ? "steelblue" : "orange")
  .transition()
  .duration(2000)
  .delay((d, i) => i * 400)
  .attr("y", d => y(d.value))
  .attr("height", d => height - y(d.value));


  // Labels on top
  g.selectAll(".label")
  .data(barData)
  .enter()
  .append("text")
  .attr("x", d => x(d.group) + x.bandwidth() / 2)
  .attr("y", height - 5) // Start low
  .attr("text-anchor", "middle")
  .style("font-size", "14px")
  .style("opacity", 0)
  .transition()
  .delay((d, i) => 2000 + i * 400)
  .duration(500)
  .style("opacity", 1)
  .attr("y", d => y(d.value) - 10)
  .text(d => `$${d.value.toFixed(2)}`);


  // Add annotation
  g.append("text")
    .attr("x", width / 2)
    .attr("y", height + 40)
    .attr("text-anchor", "middle")
    .style("fill", "#555")
    .text("In 1973, women earned 64% of what men earned");
  // d3-annotation arrow pointing to the women's bar
// const annotations = [
//   {
//     note: {
//       label: "Women earned only $17.31 in 1973",
//       title: "Wage Disparity"
//     },
//     subject: {
//       y1: y(17.31),
//       y2: y(17.31)
//     },
//     connector: {
//       end: "arrow"
//     },
//     x: x("Women") + x.bandwidth() / 2,
//     y: y(17.31),
//     dy: -70,
//     dx: -50
//   }
// ];

// const makeAnnotations = d3.annotation()
//   .type(d3.annotationLabel)
//   .annotations(annotations);

// g.append("g")
//   .attr("class", "annotation-group")
//   .call(makeAnnotations);

}

function scene2() {
  renderChart({
    animate: true,
    annotationYear: null,
    highlightYears: [2014, 2022],
    title: "Wage Gap Reached Its Narrowest Point Around 2014",
    annotationText: "By 2014, the gap had narrowed to just $5.63 — but widened slightly by 2022.",
    showTrendLines: false

  });

  setTimeout(() => {
    const svg = d3.select("#vis svg");
    const g = svg.select("g");

    const data = window.wageData;
    const width = 800 - 80 - 100;
    const height = 500 - 90 - 80;

    const x = d3.scaleLinear()
      .domain(d3.extent(data, d => d.year))
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain([0, d3.max(data, d => Math.max(d.men_average, d.women_average))])
      .range([height, 0]);

    const annotations = [
  {
    note: {
      title: "2014: Gap = $5.63",
      label: "It took 41 years for women to make 18% less than men, on average.",
    },
    connector: {
      end: "arrow",
      type: "elbow",
      lineType: "horizontal",
      lineWidth: 2,
    },
    x: x(2014),
    y: y(21.24), // more accurate: 2014 women avg
    dx: -60,
    dy: 60 // moved below
  },
  {
    note: {
      title: "2022: Gap = $7.96",
      label: "The gap increases.",
    },
    connector: {
      end: "arrow",
      type: "elbow",
      lineType: "horizontal",
      lineWidth: 2,
    },
    x: x(2022),
    y: y(27.86), // still referencing women's avg
    dx: 30,
    dy: 60 // also below
  }
];


    const makeAnnotations = d3.annotation()
      .type(d3.annotationLabel)
      .accessors({ x: d => d.x, y: d => d.y })
      .annotations(annotations)
      .textWrap(150)
      .notePadding(10);

    g.append("g")
      .attr("class", "scene2-annotations")
      .call(makeAnnotations);

    // Add supporting narrative text below chart
    d3.select("#vis")
      .append("div")
      .attr("class", "scene2-text")
      .style("margin-top", "20px")
      .style("max-width", "600px")
      .style("margin-left", "auto")
      .style("margin-right", "auto")
      .style("font-size", "16px")
      .style("color", "#333")
      .html(`
        <p>From the 1970s through 2014, the wage gap steadily narrowed; it reached its lowest point in 2014 at just <strong>$5.63</strong>. 
        This marked a milestone in wage equity between men and women.</p>
        <p>However, progress slowed after 2014, and by 2022, the wage gap had widened again to <strong>$7.96</strong>. 
        What does this say about where wage equality has been heading in recent years?</p>
      `);
  }, 2200); // Waits for animation to complete
}



function scene3() {
   d3.select("#vis").html("");
  d3.select("#annotation-text").html("");

  renderChart({
    animate: false,
    annotationYear: null,
    title: "Men Still Earn More Than Women",
    annotationText: "Despite progress, a notable wage gap remains between men and women.",
      showTrendLines: true

  });

  // Add drill-down button
  d3.select("#vis")
    .append("button")
    .attr("id", "drillBtn")
    .text("Explore Wage Gap by Decade")
    .style("margin-top", "20px")
    .style("padding", "10px 20px")
    .style("background-color", "#dbb286")
    .style("color", "white")
    .style("border", "none")
    .style("border-radius", "5px")
    .style("cursor", "pointer")
    .on("click", showDecadeDrilldown);

  // Bottom narrative
  d3.select("#vis")
    .append("div")
    .attr("class", "scene-text")
    .style("margin-top", "20px")
    .style("max-width", "600px")
    .style("margin-left", "auto")
    .style("margin-right", "auto")
    .style("font-size", "16px")
    .style("color", "#333")
    .html(`
      <p>Though both men's and women's wages have risen steadily, they’ve mostly grown in parallel. While women's wages increase, the gap doesn't follow in decreasing.
      The red trendlines show the wage gap isn't closing significantly over time. Decade-by-decade, men continue to make a notably larger average wage.</p>

    `);
}
function computeDecadeAverages(data) {
  const buckets = {
    "1970s": [],
    "1980s": [],
    "1990s": [],
    "2000s": [],
    "2010s": [],
    "2020s": []
  };

  data.forEach(d => {
    const yr = d.year;
    const bucket = yr < 1980 ? "1970s" :
                   yr < 1990 ? "1980s" :
                   yr < 2000 ? "1990s" :
                   yr < 2010 ? "2000s" :
                   yr < 2020 ? "2010s" : "2020s";
    buckets[bucket].push(d);
  });

  return Object.entries(buckets).map(([decade, records]) => {
    const avgMen = d3.mean(records, d => d.men_average);
    const avgWomen = d3.mean(records, d => d.women_average);
    return { decade, men: avgMen, women: avgWomen, gap: avgMen - avgWomen };
  });
}

function showDecadeDrilldown() {
  d3.select("#vis").html("");

  const data = computeDecadeAverages(window.wageData);

  const svg = d3.select("#vis")
    .append("svg")
    .attr("width", 700)
    .attr("height", 450);

  const margin = { top: 60, right: 30, bottom: 80, left: 70 },
        width = 700 - margin.left - margin.right,
        height = 450 - margin.top - margin.bottom;

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const x0 = d3.scaleBand()
    .domain(data.map(d => d.decade))
    .range([0, width])
    .paddingInner(0.3);

  const x1 = d3.scaleBand()
    .domain(["men", "women"])
    .range([0, x0.bandwidth()])
    .padding(0.1);

  const y = d3.scaleLinear()
    .domain([0, d3.max(data, d => Math.max(d.men, d.women)) + 5])
    .range([height, 0]);

  const color = d3.scaleOrdinal()
    .domain(["men", "women"])
    .range(["steelblue", "orange"]);

  // Axes
  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x0));

  g.append("g").call(d3.axisLeft(y));

  // Bars
  g.selectAll(".bar-group")
    .data(data.flatMap(d => [
      { group: "men", value: d.men, decade: d.decade },
      { group: "women", value: d.women, decade: d.decade }
    ]))
    .enter()
    .append("rect")
    .attr("x", d => x0(d.decade) + x1(d.group))
    .attr("width", x1.bandwidth())
    .attr("y", height)
    .attr("height", 0)
    .attr("fill", d => color(d.group))
    .transition().duration(1000)
    .attr("y", d => y(d.value))
    .attr("height", d => height - y(d.value));

  // Title
  svg.append("text")
    .attr("x", 350)
    .attr("y", 30)
    .attr("text-anchor", "middle")
    .text("Average Wages by Decade")
    .style("font-size", "16px")
    .style("font-weight", "bold");

  // Back button
  d3.select("#vis")
    .append("button")
    .attr("id", "backBtn")
    .text("← Back to Line Chart")
    .style("margin-top", "20px")
    .style("padding", "10px 20px")
    .style("background-color", "#888")
    .style("color", "white")
    .style("border", "none")
    .style("border-radius", "5px")
    .style("cursor", "pointer")
    .on("click", scene3);
}
function getTrendLine(data, accessorX, accessorY) {
  const xSeries = data.map(accessorX);
  const ySeries = data.map(accessorY);
  const n = xSeries.length;

  const xMean = d3.mean(xSeries);
  const yMean = d3.mean(ySeries);

  const slope = d3.sum(xSeries.map((x, i) => (x - xMean) * (ySeries[i] - yMean))) /
                d3.sum(xSeries.map(x => (x - xMean) ** 2));

  const intercept = yMean - slope * xMean;

  const xMin = d3.min(xSeries);
  const xMax = d3.max(xSeries);

  return [
    { x: xMin, y: slope * xMin + intercept },
    { x: xMax, y: slope * xMax + intercept }
  ];
}


function scene4() {
  d3.select("#vis").html(""); // Clear previous content

  // Container div
  const container = d3.select("#vis")
    .append("div")
    .attr("class", "scene4-container");

  // Conclusion text
  container.append("div")
    .attr("class", "scene4-text")
    .html(`
      <h2>As of 2022: The Wage Gap Persists</h2>
      <p>Despite steady growth in women’s wages, <strong>men still earn more on average</strong>.
         In 2022, the average hourly wage for men was <strong>$35.82</strong>, while for women it was <strong>$27.86</strong>.</p>
      <p>This reflects a wage gap of <strong>$7.96</strong>, or <strong>22%</strong> — a persistent gap that has <em>widened</em> slightly since its lowest point in 2014.</p>
    `);

  // Bar chart dimensions
  const svgWidth = 500;
  const svgHeight = 300;
  const margin = { top: 30, right: 20, bottom: 50, left: 80 };
  const width = svgWidth - margin.left - margin.right;
  const height = svgHeight - margin.top - margin.bottom;

  // 2022 data
  const barData = [
    { group: "Men", value: 35.82 },
    { group: "Women", value: 27.86 }
  ];

  const svg = container.append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

  const x = d3.scaleBand()
    .domain(barData.map(d => d.group))
    .range([0, width])
    .padding(0.4);

  const y = d3.scaleLinear()
    .domain([0, d3.max(barData, d => d.value) * 1.2])
    .range([height, 0]);

  // Axes
  g.append("g")
    .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(x));

  g.append("g")
    .call(d3.axisLeft(y).ticks(5));

  // Bars with transition
  g.selectAll(".bar")
    .data(barData)
    .enter()
    .append("rect")
    .attr("class", "bar")
    .attr("x", d => x(d.group))
    .attr("y", height)
    .attr("width", x.bandwidth())
    .attr("height", 0)
    .attr("fill", d => d.group === "Men" ? "steelblue" : "orange")
    .transition()
    .duration(2000)
    .delay((d, i) => i * 400)
    .attr("y", d => y(d.value))
    .attr("height", d => height - y(d.value));

  // Value labels
  g.selectAll(".label")
    .data(barData)
    .enter()
    .append("text")
    .attr("x", d => x(d.group) + x.bandwidth() / 2)
    .attr("y", height - 5)
    .attr("text-anchor", "middle")
    .style("font-size", "14px")
    .style("opacity", 0)
    .transition()
    .delay((d, i) => 2000 + i * 400)
    .duration(500)
    .style("opacity", 1)
    .attr("y", d => y(d.value) - 10)
    .text(d => `$${d.value.toFixed(2)}`);

  // Annotation under chart
  g.append("text")
    .attr("x", width / 2)
    .attr("y", height + 40)
    .attr("text-anchor", "middle")
    .style("fill", "#555")
    .text("In 2022, women earned 78% of what men earned");
}






    init(); // kick things off
  </script>
  
</body>
</html>
